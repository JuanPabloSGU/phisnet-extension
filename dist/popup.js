(()=>{"use strict";document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("login");e?.addEventListener("click",(async()=>{const e=function(){let e="";for(let t=0;t<128;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~"[Math.floor(66*Math.random())];return e}(),t=await async function(e){const t=(new TextEncoder).encode(e),o=await crypto.subtle.digest("SHA-256",t);return btoa(String.fromCharCode(...new Uint8Array(o))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}(e);localStorage.setItem("code_verifier",e);const o="287272511991840275",r=chrome.identity.getRedirectURL("oauth2"),n=`https://zitadel.databending.ca/oauth/v2/authorize?client_id=${o}&redirect_uri=${encodeURIComponent(r)}&scope=openid profile email offline_access&response_type=code&response_mode=query&code_challenge_method=S256&code_challenge=${t}&state=ybshps1hnzh&nonce=nz9ng1ee42e`;chrome.identity.launchWebAuthFlow({url:n,interactive:!0},(e=>{if(chrome.runtime.lastError)return void console.error(chrome.runtime.lastError.message);if(!e)return void console.error("Redirect URI is empty");const t=new URL(e).searchParams.get("code");if(t){const e=localStorage.getItem("code_verifier");fetch("https://zitadel.databending.ca/oauth/v2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({code:t,grant_type:"authorization_code",redirect_uri:chrome.identity.getRedirectURL("oauth2"),client_id:o,code_verifier:e||""})}).then((e=>e.json())).then((e=>{e.access_token&&chrome.storage.local.set({jwt:e.id_token,token:e.access_token},(()=>{chrome.runtime.lastError?console.error(chrome.runtime.lastError.message):(chrome.storage.local.get(["jwt","token"],(e=>{chrome.runtime.lastError?console.error("Error retrieving data:",chrome.runtime.lastError.message):console.log("Data retrieved:",e)})),console.log("JWT and token saved"),chrome.runtime.sendMessage({token:e.access_token}),chrome.runtime.sendMessage({jwt:e.id_token}),chrome.action.setPopup({popup:"home.html"}),window.location.href="home.html")}))})).catch((e=>{console.error("Error fetching data:",e)}))}else console.error("Authorization code is empty")}))}))}))})();